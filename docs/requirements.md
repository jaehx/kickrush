# 요구사항 정의서

## 1. 서비스 개요
- **한 줄 설명**: 한정판 신발 드롭(FCFS)에서 대규모 동시성 트래픽과 재고 정합성을 보장하는 백엔드 시스템
- **문제/가치**: 발매 시점 폭주 트래픽에서 초과 판매/중복 주문을 방지하고 재고를 원자적으로 관리
- **대상 사용자**: 구매자(일반 회원), 운영자/관리자, 비회원(조회만)
- **성공 지표(KPI/OKR)**:
  - 초과 판매 0건
  - 중복 주문 0건
  - 주문 생성 성공률 99%+
  - 주문 API 응답시간 p99 < 500ms

## 2. 사용자 시나리오
- **시나리오 1**: 비회원이 발매/상품 목록을 조회한다
- **시나리오 2**: 회원이 발매 시점에 원하는 사이즈를 선택하여 주문을 시도한다
- **시나리오 3**: 발매 시간 전/후에는 주문이 차단된다
- **시나리오 4**: 운영자가 상품/발매/재고를 등록·수정하고 주문 취소 시 재고가 복구된다

## 3. 범위
### In Scope
- 상품/발매/재고/주문/회원 도메인
- **사이즈별 재고 관리**
- 동시성 제어(재고 차감)
- 중복 주문 방지
- **발매 시간 검증**
- JWT 인증
- REST API

### Out of Scope
- 결제/배송/정산/알림 서비스
- 외부 마켓 연동
- 프론트 UI 완성(프론트는 예정)
- 봇 탐지/CAPTCHA
- 대기열(Queue) 시스템

## 4. 기능 요구사항

### 4.1 기능 목록
- [ ] 상품(Shoe) 등록/조회 기능
- [ ] 발매(Release) 등록/조회 기능
- [ ] **사이즈(Size) 관리 기능**
- [ ] 재고(Stock) 관리 및 원자적 차감 기능
- [ ] 주문(Order) 생성/조회/취소 기능
- [ ] 회원(Member) 가입 및 인증(JWT) 기능
- [ ] 중복 주문 방지 기능
- [ ] 동시성 제어 기능
- [ ] **발매 시간 검증 기능**
- [ ] 비회원 조회 API 접근 허용

### 4.2 기능 상세

#### 기능 A: 발매/상품 조회 API
| 항목 | 내용 |
|------|------|
| 설명 | 발매 목록 및 상세 정보를 제공한다(비회원 접근 가능) |
| 입력 | 선택적 필터(상태, 기간, 브랜드) |
| 출력 | 발매 리스트/상세(사이즈별 재고 현황 포함) |
| 예외/오류 | `INVALID_PARAMETER` - 잘못된 파라미터 |
| 권한/역할 | 비회원/회원 모두 조회 가능 |
| 수용 기준 | 비회원도 정상 조회 가능, 회원/비회원 동일 응답 규격 |

#### 기능 B: 발매 시간 검증
| 항목 | 내용 |
|------|------|
| 설명 | 발매 시작 전/종료 후 주문 시도를 차단한다 |
| 입력 | releaseId, 현재 시간 |
| 출력 | 주문 가능 여부 |
| 예외/오류 | `RELEASE_NOT_STARTED` - 발매 전, `RELEASE_ENDED` - 발매 종료 |
| 권한/역할 | 로그인 회원만 가능 |
| 수용 기준 | 발매 시간 외 주문 시도 시 100% 차단 |

#### 기능 C: 재고 차감(동시성 제어 포함)
| 항목 | 내용 |
|------|------|
| 설명 | 발매 주문 시 해당 사이즈의 재고를 원자적으로 차감하고, 동시 요청에서도 초과 판매를 방지한다 |
| 입력 | releaseId, **sizeId**, memberId, quantity(기본 1) |
| 출력 | 차감 성공 여부, 남은 재고 |
| 예외/오류 | `STOCK_INSUFFICIENT` - 재고 부족, `LOCK_TIMEOUT` - 잠금 타임아웃, `RELEASE_NOT_FOUND` - 존재하지 않는 발매 |
| 권한/역할 | 로그인 회원만 가능 |
| 수용 기준 | 동시 요청에서도 초과 판매 0건, 실패 요청은 재고 부족 오류 반환 |

#### 기능 D: 주문 생성 및 중복 주문 방지
| 항목 | 내용 |
|------|------|
| 설명 | 동일 회원이 동일 발매의 **동일 사이즈**에 중복 주문하지 못하도록 차단한다 |
| 입력 | releaseId, **sizeId**, memberId, 주문 정보 |
| 출력 | 주문 생성 결과, 주문 ID |
| 예외/오류 | `DUPLICATE_ORDER` - 중복 주문, `STOCK_INSUFFICIENT` - 재고 부족 |
| 권한/역할 | 로그인 회원만 가능 |
| 수용 기준 | 같은 회원의 동일 발매+사이즈 주문이 2회 이상 생성되지 않음 |

#### 기능 E: 주문 취소 및 재고 복구
| 항목 | 내용 |
|------|------|
| 설명 | 주문 취소 시 재고를 복구하고 주문 상태를 변경한다 |
| 입력 | orderId |
| 출력 | 취소 결과, 재고 복구 상태 |
| 예외/오류 | `ORDER_NOT_CANCELLABLE` - 취소 불가 상태, `ORDER_NOT_FOUND` - 주문 없음 |
| 권한/역할 | 주문 생성한 회원 또는 관리자 |
| 수용 기준 | 취소 후 재고 수량이 정확히 복구됨 |

### 4.3 에러 응답 규격

모든 에러는 다음 형식을 따른다:

```json
{
  "code": "ERROR_CODE",
  "message": "사용자 친화적 메시지",
  "timestamp": "2026-02-07T15:00:00Z"
}
```

| HTTP 상태 | 에러 코드 | 설명 |
|-----------|----------|------|
| 400 | `INVALID_PARAMETER` | 잘못된 요청 파라미터 |
| 400 | `RELEASE_NOT_STARTED` | 발매 시작 전 |
| 400 | `RELEASE_ENDED` | 발매 종료 |
| 401 | `UNAUTHORIZED` | 인증 필요 |
| 403 | `FORBIDDEN` | 권한 없음 |
| 404 | `RELEASE_NOT_FOUND` | 발매 없음 |
| 404 | `ORDER_NOT_FOUND` | 주문 없음 |
| 409 | `STOCK_INSUFFICIENT` | 재고 부족 |
| 409 | `DUPLICATE_ORDER` | 중복 주문 |
| 409 | `ORDER_NOT_CANCELLABLE` | 취소 불가 상태 |
| 503 | `LOCK_TIMEOUT` | 락 획득 실패 |

## 5. 도메인 모델

### 5.1 엔티티 관계

```
Shoe (상품)
  └── Release (발매)
        └── ReleaseSize (사이즈별 재고)
              └── Order (주문)
                    └── Member (회원)
```

### 5.2 핵심 엔티티

| 엔티티 | 주요 속성 | 설명 |
|--------|----------|------|
| Shoe | id, name, brand, description, imageUrl | 신발 상품 정보 |
| Release | id, shoeId, releaseAt, endAt, status | 발매 정보 |
| ReleaseSize | id, releaseId, size, stock, price | 사이즈별 재고/가격 |
| Order | id, memberId, releaseSizeId, status, orderedAt | 주문 정보 |
| Member | id, email, password, role | 회원 정보 |

### 5.3 사이즈 관리

- 신발 사이즈: 220, 225, 230, ... 300 (5mm 단위, 한국 기준)
- 각 발매(Release)마다 사이즈별 재고(stock)와 가격(price)을 별도 관리
- 동일 발매라도 사이즈별로 재고 차감/복구가 독립적으로 수행됨

## 6. 비기능 요구사항

### 6.1 성능 목표

| 지표 | 목표값 | 비고 |
|------|--------|------|
| 동시 접속자 | 1,000명 | 발매 시점 피크 기준 |
| 처리량(TPS) | 500 TPS | 주문 API 기준 |
| 주문 API 응답시간 | p99 < 500ms | 락 대기 포함 |
| 조회 API 응답시간 | p99 < 100ms | |
| 재고 차감 처리량 | 100건/초 이상 | 단일 발매 기준 |

> ⚠️ 위 수치는 **포트폴리오 학습 목적의 가정값**입니다. 실제 서비스에서는 부하 테스트를 통해 조정해야 합니다.

### 6.2 보안
- JWT 기반 인증
- 인증/인가 실패 시 표준 에러 응답
- 비밀번호 암호화(BCrypt)
- API Rate Limiting: 비회원 100req/min, 회원 300req/min (가정)

### 6.3 가용성/복구
- 재고/주문 정합성 보장을 위한 트랜잭션
- 장애 시 롤백 가능
- 무상태(Stateless) 설계로 수평 확장 대응

### 6.4 운영/모니터링
- 요청/에러 로그
- 재고/주문 이상 탐지 지표
- 락 경합/타임아웃 모니터링

### 6.5 데이터 보관 정책 (가정)
| 데이터 | 보관 기간 | 비고 |
|--------|----------|------|
| 주문 데이터 | 1년 | 이후 아카이브 |
| 회원 데이터 | 탈퇴 후 30일 | 이후 삭제 |
| 로그 데이터 | 90일 | 이후 삭제 |

## 7. 기술 결정 및 대안 분석

### 7.1 동시성 제어 전략

**선택: Pessimistic Lock (비관적 락)**

| 대안 | 장점 | 단점 |
|------|------|------|
| **Pessimistic Lock (선택)** | 정합성 100% 보장, 구현 단순, DB 레벨 지원 | 락 경합 시 처리량 저하, 데드락 가능성 |
| Optimistic Lock | 읽기 성능 우수, 락 대기 없음 | 충돌 시 재시도 필요, 높은 경합 시 비효율 |
| Redis SETNX 분산 락 | 확장성 우수, DB 부하 분산 | 네트워크 지연, 락 해제 실패 시 문제, 복잡도 증가 |
| Redis DECR 원자 연산 | 가장 빠름, 확장성 최고 | DB/Redis 정합성 별도 보장 필요, 롤백 복잡 |
| Message Queue 기반 | 순차 처리로 경합 없음, 확장성 | 응답 지연, 구현 복잡도 높음 |

**선택 이유**:
- 학습 목적으로 **정합성 우선**, 구현 복잡도 최소화
- 목표 트래픽(500 TPS) 수준에서는 DB 락으로 충분
- 추후 성능 병목 발생 시 Redis 분산 락으로 전환 고려

---

### 7.2 중복 주문 방지 전략

**선택: DB Unique Constraint + 애플리케이션 검증**

| 대안 | 장점 | 단점 |
|------|------|------|
| **DB Unique Constraint (선택)** | 100% 방지 보장, 구현 단순 | DB 레벨 제약, 에러 핸들링 필요 |
| Redis SET NX | 빠름, DB 부하 분산 | 휘발성, 장애 시 누락 가능 |
| 애플리케이션 레벨만 | 유연함 | Race condition 발생 가능 |

**선택 이유**:
- `(member_id, release_size_id)` 조합에 Unique Index 설정
- 애플리케이션에서 먼저 검증 후, DB 제약으로 최종 보장
- 동시 요청 시에도 DB 레벨에서 확실히 차단

---

### 7.3 인증 방식

**선택: JWT (Access Token + Refresh Token)**

| 대안 | 장점 | 단점 |
|------|------|------|
| **JWT (선택)** | 무상태, 확장성, 표준화 | 토큰 탈취 위험, 즉시 무효화 어려움 |
| Session 기반 | 즉시 무효화 가능, 보안성 | 서버 상태 저장 필요, 확장성 제한 |
| OAuth 2.0 | 소셜 로그인 지원, 표준화 | 구현 복잡도, 외부 의존성 |

**선택 이유**:
- 무상태 설계로 수평 확장 용이
- Access Token(15분) + Refresh Token(7일) 조합
- 포트폴리오 프로젝트로 소셜 로그인은 범위 외

---

### 7.4 데이터베이스 선택

**선택: PostgreSQL (프로덕션) + H2 (테스트)**

| 대안 | 장점 | 단점 |
|------|------|------|
| **PostgreSQL (선택)** | 안정성, ACID 보장, 풍부한 기능 | 설정 복잡도 |
| MySQL | 널리 사용, 성능 우수 | PostgreSQL 대비 기능 제한적 |
| H2 (테스트용) | 빠른 테스트, 설정 간편 | 프로덕션 부적합 |

**선택 이유**:
- Row-level locking 지원으로 동시성 처리에 적합
- JSON 타입 등 확장 기능 활용 가능
- 테스트 시 H2로 빠른 피드백, Testcontainers로 통합 테스트

---

### 7.5 캐시 전략

**선택: Redis (조회 캐시 + 분산 락 준비)**

| 대안 | 장점 | 단점 |
|------|------|------|
| **Redis (선택)** | 빠름, 분산 락 지원, 널리 사용 | 별도 인프라, 메모리 비용 |
| Local Cache (Caffeine) | 설정 간단, 네트워크 없음 | 분산 환경 동기화 어려움 |
| 캐시 없음 | 단순함 | 조회 성능 저하, DB 부하 |

**선택 이유**:
- 발매/상품 조회에 캐시 적용으로 DB 부하 감소
- 추후 분산 락 전환 시에도 인프라 재활용
- TTL 기반 캐시 무효화 (발매 정보: 1분, 상품 정보: 5분)

## 8. 데이터/연동

### 8.1 데이터 소스
| 환경 | DB | 캐시/락 |
|------|-----|---------|
| 로컬 | H2 | Embedded Redis |
| 테스트 | H2 / Testcontainers | Testcontainers Redis |
| 프로덕션 | PostgreSQL | Redis |

### 8.2 외부 연동
- 없음 (1차 범위)

## 9. 의존성

### 9.1 기술 스택
| 구분 | 기술 | 버전 |
|------|------|------|
| 언어 | Java | 17 |
| 프레임워크 | Spring Boot | 3.2.2 |
| 빌드 | Gradle | 8.x |
| ORM | Spring Data JPA | - |
| 캐시 | Spring Data Redis | - |
| 테스트 | JUnit 5, Testcontainers | - |

### 9.2 팀/조직 의존성
- 없음 (개인/학습 프로젝트)

## 10. 리스크 및 완화 전략

| 리스크 | 영향 | 완화 전략 |
|--------|------|----------|
| Pessimistic Lock 병목 | 처리량 저하, 타임아웃 증가 | 락 타임아웃 설정, 모니터링, 필요시 Redis 락 전환 |
| 발매 시점 트래픽 폭주 | 서버 과부하, 에러 증가 | Rate Limiting, 커넥션 풀 튜닝, 비동기 처리 고려 |
| 데드락 발생 | 트랜잭션 실패 | 락 순서 일관성 유지, 타임아웃 설정 |
| Redis 장애 | 캐시 미스, 성능 저하 | Fallback to DB, Circuit Breaker 패턴 |

## 11. 가정 및 제약사항

### 11.1 가정
- 결제/배송 연동은 범위 외
- 발매/상품 CRUD는 관리자 기능으로 제공
- 봇 탐지/CAPTCHA는 범위 외
- 단일 인스턴스 배포 기준 (추후 확장 고려)

### 11.2 제약사항
- 비회원은 조회 API만 접근 가능
- 한 회원당 동일 발매+사이즈 1건만 주문 가능
- 발매 시간 외 주문 불가

## 12. 검증/테스트 관점

### 12.1 테스트 전략
- **TDD 기반**: Red → Green → Refactor 사이클
- **유닛 테스트**: 도메인 로직, 서비스 레이어
- **리포지토리 테스트**: JPA 쿼리 검증
- **통합 테스트**: API 엔드포인트, Testcontainers 활용
- **동시성 테스트**: ExecutorService로 병렬 요청 시뮬레이션

### 12.2 동시성 테스트 시나리오

| 시나리오 | 조건 | 기대 결과 |
|----------|------|----------|
| 초과 판매 방지 | 재고 10개, 동시 100명 주문 | 정확히 10명 성공, 90명 `STOCK_INSUFFICIENT` |
| 중복 주문 방지 | 동일 회원 동시 2건 주문 | 1건 성공, 1건 `DUPLICATE_ORDER` |
| 취소 후 재고 복구 | 주문 완료 직후 취소 | 재고 정확히 +1 복구 |
| 발매 시간 검증 | 발매 전 주문 시도 | 100% `RELEASE_NOT_STARTED` |

### 12.3 수용 기준 요약
- [ ] 비회원 조회 API 정상 동작
- [ ] 재고 초과 판매 0건
- [ ] 중복 주문 0건
- [ ] 발매 시간 외 주문 100% 차단
- [ ] 취소 시 재고 정확히 복구
- [ ] 모든 에러에 표준 응답 형식 적용

## 13. 결정 로그

| 일자 | 결정 | 배경 | 대안 | 선택 이유 |
|------|------|------|------|----------|
| 2026-02-07 | 동시성 제어: Pessimistic Lock | 초과 판매 방지 필수 | Optimistic Lock, Redis 분산 락, DECR | 정합성 우선, 구현 단순 |
| 2026-02-07 | 중복 방지: DB Unique Constraint | 중복 주문 차단 필수 | Redis SET NX, 앱 레벨만 | DB 레벨 보장 확실 |
| 2026-02-07 | 인증: JWT | 무상태 설계 | Session, OAuth | 확장성, 단순성 |
| 2026-02-07 | 사이즈별 재고 관리 추가 | 신발 도메인 특성 | 단일 재고 | 실제 서비스 요구사항 반영 |

## 14. 일정/마일스톤

| Phase | 내용 | 상태 |
|-------|------|------|
| Phase 1 | 프로젝트 셋업, 도메인 모델 | ✅ 완료 |
| Phase 2 | 재고 관리 (동시성 제어) | 🔄 진행 중 |
| Phase 3 | 주문 처리 (중복 방지) | ⏳ 예정 |
| Phase 4 | 회원 관리 (JWT 인증) | ⏳ 예정 |
| Phase 5 | API 레이어 완성 | ⏳ 예정 |
| Phase 6 | 성능 테스트 및 최적화 | ⏳ 예정 |
